<script setup>
import { Field, Form, useForm } from "vee-validate";
import SmallModal from "@/components/SmallModal.vue";
import { storeToRefs } from "pinia";
import { ref, watch } from "vue";
import { useBlocoDeNotasStore } from "@/stores/blocoNotas.store";
import { nota as schema } from "@/consts/formSchemas";
import { useAlertStore } from "@/stores/alert.store";
import { useTipoDeNotasStore } from "@/stores/tipoNotas.store";

const alertStore = useAlertStore();
const status = [
  {
    value: "Programado",
    text: "Programado",
  },
  {
    value: "Em_Curso",
    text: "Em curso",
  },
  {
    value: "Suspenso",
    text: "Suspenso",
  },
  {
    value: "Cancelado",
    text: "Cancelado",
  },
];

const blocoStore = useBlocoDeNotasStore();
const {
  lista: listaNotas,
  erro,
  chamadasPendentes,
  emFoco,
  itemParaEdição,
} = storeToRefs(blocoStore);

const tipoStore = useTipoDeNotasStore();
const { lista: listaTipo, erro: erroTipo } = storeToRefs(tipoStore);

const exibeModalNotas = ref(false);
const exibeForm = ref(false);

const { errors, handleSubmit, isSubmitting, resetForm, values } = useForm({
  initialValues: itemParaEdição.value,
  validationSchema: schema,
});

const props = defineProps({
  blocosToken: {
    type: String,
    required: true,
  },
});

const onSubmit = handleSubmit.withControlled(async (valoresControlados) => {
  const valoresAuxiliares = {
    ...values,
    bloco_token: props.blocosToken,
  };
  try {
    let resposta;
    const msg = "Dados salvos com sucesso!";
    resposta = await blocoStore.salvarItem(valoresAuxiliares);
    if (resposta) {
      alertStore.success(msg);
      blocoStore.$reset();
      blocoStore.buscarTudo(props.blocosToken);
    }
  } catch (error) {
    alertStore.error(error);
  }
});

async function excluirNota(id) {
  useAlertStore().confirmAction(
    "Deseja mesmo remover a nota?",
    async () => {
      if (await blocoStore.excluirItem(id)) {
        blocoStore.$reset();
        blocoStore.buscarTudo(props.blocosToken);
        useAlertStore().success("Tarefa removida.");
      }
    },
    "Remover"
  );
}

function editarNota(id) {
  exibeForm.value = true;
  blocoStore.buscarItem(id);
}

function fecharForm(){
  emFoco.value = null
  exibeForm.value = false;
}

watch(() => props.blocosToken, () => {
  if(props.blocosToken){
    blocoStore.buscarTudo(props.blocosToken);
  }
},{ immediate: true });

tipoStore.buscarTudo();

watch(itemParaEdição, (novosValores) => {
  resetForm({ values: novosValores });
});
</script>

<template>
  <!-- em desenvolvimento -->
  <button class="flex center g1 like-a__text" @click="exibeModalNotas = true">
    <svg
      width="16"
      height="20"
      viewBox="0 0 16 20"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M10 0.186053C10.293 0.332053 10.625 0.603053 10.996 0.999053L15.003 5.00505C15.43 5.38505 15.703 5.71705 15.822 6.00205C15.941 6.28705 16 6.62005 16 7.00205V18.0021C16 19.3351 15.333 20.0021 14 20.0021H2.002C0.667 20.0031 0 19.3361 0 18.0021V2.00205C0 0.669053 0.667 0.00205337 2 0.00205337H8.996C9.054 0.00205337 9.56 -0.0329466 10 0.186053ZM2 18.0021H14.001L14 8.00205H10C9.46957 8.00205 8.96086 7.79134 8.58579 7.41627C8.21071 7.04119 8 6.53249 8 6.00205V2.00205H2V18.0021ZM10 3.00205V6.00205H13L10 3.00205ZM5 12.0021C4.333 12.0021 4 11.6691 4 11.0021C4 10.3351 4.334 10.0021 5.001 10.0021H11C11.667 10.0021 12 10.3351 12 11.0021C12 11.6691 11.667 12.0021 11 12.0021H5ZM5 8.00205C4.333 8.00205 4 7.66905 4 7.00205C4 6.33505 4.334 6.00205 5.001 6.00205H6C6.667 6.00205 7 6.33505 7 7.00205C7 7.66905 6.667 8.00205 6 8.00205H5ZM5 16.0021C4.333 16.0021 4 15.6691 4 15.0021C4 14.3351 4.333 14.0021 5 14.0021H11C11.667 14.0021 12 14.3351 12 15.0021C12 15.6691 11.667 16.0021 11 16.0021H5Z"
        fill="#3B5881"
      />
    </svg>
    Notas
  </button>
  <SmallModal v-if="exibeModalNotas">
    <div class="flex spacebetween center mb2">
      <h2>Notas</h2>
      <hr class="ml2 f1" />
      <CheckClose
        @close="
          exibeModalNotas = false;
          fecharForm();
        "
        :apenas-emitir="true"
      />
    </div>
    <button
      v-if="!exibeForm"
      class="like-a__text addlink mb2"
      @click="exibeForm = true"
    >
      <svg width="20" height="20">
        <use xlink:href="#i_+" />
      </svg>
      Adicionar nova nota
    </button>
    <button v-else  class="like-a__text addlink mb2" @click.prevent="fecharForm()">Cancelar</button>
    <div class="mb4" v-if="exibeForm">
      <form @submit.prevent="onSubmit">
        <div class="flex mb2 flexwrap g2">
          <div class="f1">
            <LabelFromYup name="status" :schema="schema" />
            <Field name="status" as="select" class="inputtext light mb1">
              <option value>Selecionar</option>
              <option
                v-for="(item, key) in status"
                :key="key"
                :value="item.value"
              >
                {{ item.text }}
              </option>
            </Field>
          </div>
          <div class="f1">
            <LabelFromYup name="tipo_nota_id" :schema="schema" />
            <Field name="tipo_nota_id" as="select" class="inputtext light mb1">
              <option value>Selecionar</option>
              <option
                v-for="(tipo, key) in listaTipo"
                :key="key"
                :value="tipo.id"
              >
                {{ tipo.codigo }}
              </option>
            </Field>
          </div>
        </div>
        <div class="flex">
          <div class="f1">
            <LabelFromYup name="dispara_email" :schema="schema" />
            <Field
              name="dispara_email"
              type="checkbox"
              class="inputcheckbox"
              :value="true"
              :unchecked-value="false"
            />
          </div>
          <div class="f1">
            <LabelFromYup name="data_nota" :schema="schema" />
            <Field name="data_nota" type="date" class="inputtext light"  placeholder="dd/mm/aaaa"/>
          </div>
        </div>
        <div class="mb2">
          <LabelFromYup name="nota" :schema="schema" />
          <Field
            name="nota"
            type="textarea"
            class="inputtext light mb1"
            as="textarea"
            rows="10"
          />
        </div>
        <FormErrorsList :errors="errors" class="mb1" />
        <div class="flex spacebetween center mb2">
          <hr class="mr2 f1" />
          <button
            class="btn big"
            :disabled="isSubmitting || Object.keys(errors)?.length"
            :title="
              Object.keys(errors)?.length
                ? `Erros de preenchimento: ${Object.keys(errors)?.length}`
                : null
            "
          >
            Salvar
          </button>
          <hr class="ml2 f1" />
        </div>
      </form>
    </div>

    <table class="tablemain mb1">
      <col />
      <col />
      <col />
      <col class="col--botão-de-ação" />
      <col class="col--botão-de-ação" />
      <thead>
        <tr>
          <th>Nota</th>
          <th>Status</th>
          <th>Tipo</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(item, key) in listaNotas" :key="key">
          <td>
            {{ item.nota }}
          </td>
          <td>
            <!-- formatar -->
            {{ item.status }}
          </td>
          <td>
            {{
              listaTipo.find((tipo) => tipo.id === item.tipo_nota_id)?.codigo
            }}
          </td>
          <td>
            <button
              @click="excluirNota(item.id_jwt)"
              class="like-a__text"
              arial-label="Excluir"
              title="Excluir"
            >
              <svg width="20" height="20">
                <use xlink:href="#i_remove" />
              </svg>
            </button>
          </td>
          <td>
            <button
              @click="editarNota(item.id_jwt)"
              arial-label="Editar"
              title="Editar"
              class="like-a__text"
            >
              <svg width="20" height="20">
                <use xlink:href="#i_edit" />
              </svg>
            </button>
          </td>
        </tr>
        <tr v-if="chamadasPendentes.listaNotas">
          <td colspan="10">Carregando</td>
        </tr>
        <tr v-else-if="erro">
          <td colspan="10">Erro: {{ erro }}</td>
        </tr>
        <tr v-else-if="!listaNotas.length">
          <td colspan="10">Nenhum resultado encontrado.</td>
        </tr>
      </tbody>
    </table>
  </SmallModal>
</template>
