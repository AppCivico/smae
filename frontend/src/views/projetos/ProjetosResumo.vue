<script setup>
import MenuDeMudançaDeStatusDeProjeto from '@/components/projetos/MenuDeMudançaDeStatusDeProjeto.vue';
import { projeto as schema } from '@/consts/formSchemas';
import statuses from '@/consts/projectStatuses';
import dateToField from '@/helpers/dateToField';
import dinheiro from '@/helpers/dinheiro';
import subtractDates from '@/helpers/subtractDates';
import truncate from '@/helpers/truncate';
import { useDotaçãoStore } from '@/stores/dotacao.store.ts';
import { useProjetosStore } from '@/stores/projetos.store.ts';
import { storeToRefs } from 'pinia';

const DotaçãoStore = useDotaçãoStore();
const projetosStore = useProjetosStore();

const { FontesDeRecursosPorAnoPorCódigo } = storeToRefs(DotaçãoStore);
const {
  chamadasPendentes, emFoco, erro,
} = storeToRefs(projetosStore);

defineProps({
  projetoId: {
    type: Number,
    default: 0,
  },
});
</script>
<template>
  <div class="flex spacebetween center mb2">
    <h1>{{ emFoco?.nome }}</h1>
    <hr class="ml2 f1">
    <MenuDeMudançaDeStatusDeProjeto />

    <template v-if="emFoco?.id && !emFoco.arquivado">
      <router-link
        :to="{ name: 'projetosEditar', params:{ projetoId: emFoco.id }}"
        class="btn big ml2"
      >
        Editar
      </router-link>
    </template>
  </div>

  <div class="boards">
    <div class="flex g2 mb1 flexwrap">
      <dl
        v-if="emFoco?.codigo"
        class="f1 mb1"
      >
        <dt class="t12 uc w700 mb05 tamarelo">
          {{ schema.fields['codigo'].spec.label }}
        </dt>
        <dd class="t13">
          {{ emFoco?.codigo }}
        </dd>
      </dl>
      <dl class="f1 mb1">
        <dt class="t12 uc w700 mb05 tamarelo">
          Status
        </dt>
        <dd class="t13">
          {{ statuses[emFoco?.status] || emFoco?.status }}
        </dd>
      </dl>
    </div>

    <hr class="mb1 f1">

    <div class="mb1">
      <h3 class="label mt2 mb1legend">
        Logradouro
      </h3>

      <div class="flex g2 mb1 flexwrap">
        <dl class="f1 mb1">
          <dt class="t12 uc w700 mb05 tamarelo">
            {{ schema.fields['regiao_id'].spec.label }}
          </dt>
          <dd class="t13">
            {{ emFoco?.regiao?.descricao || '-' }}
          </dd>
        </dl>
        <dl class="f1 mb1">
          <dt class="t12 uc w700 mb05 tamarelo">
            CEP
          </dt>
          <dd class="t13">
            {{ emFoco?.logradouro_cep || '-' }}
          </dd>
        </dl>
        <dl class="f1 mb1">
          <dt class="t12 uc w700 mb05 tamarelo">
            Tipo
          </dt>
          <dd class="t13">
            {{ emFoco?.logradouro_tipo || '-' }}
          </dd>
        </dl>
        <dl class="f2 mb1">
          <dt class="t12 uc w700 mb05 tamarelo">
            Nome
          </dt>
          <dd class="t13">
            {{ emFoco?.logradouro_nome || '-' }}
          </dd>
        </dl>
        <dl class="f1 mb1">
          <dt class="t12 uc w700 mb05 tamarelo">
            Número
          </dt>
          <dd class="t13">
            {{ emFoco?.logradouro_numero || '-' }}
          </dd>
        </dl>
      </div>
    </div>

    <hr class="mb1 f1">

    <div class="flex g2">
      <dl class="f1 mb1">
        <dt class="t12 uc w700 mb05 tamarelo">
          {{ schema.fields['resumo'].spec.label }}
        </dt>
        <dd class="t13">
          {{ emFoco?.resumo || '-' }}
        </dd>
      </dl>
    </div>
    <hr class="mb1 f1">
    <div class="flex g2">
      <dl class="f1 mb1">
        <dt class="t12 uc w700 mb05 tamarelo">
          {{ schema.fields['objetivo'].spec.label }}
        </dt>
        <dd
          class="t13"
          v-html="emFoco?.objetivo || '-'"
        />
      </dl>
    </div>

    <div class="flex g2">
      <dl class="f1 mb1">
        <dt class="t12 uc w700 mb05 tamarelo">
          {{ schema.fields['objeto'].spec.label }}
        </dt>
        <dd
          class="t13"
          v-html="emFoco?.objeto || '-'"
        />
      </dl>
    </div>

    <div class="flex g2">
      <dl class="f1 mb1">
        <dt class="t12 uc w700 mb05 tamarelo">
          {{ schema.fields['publico_alvo'].spec.label }}
        </dt>
        <dd
          class="t13"
          v-html="emFoco?.publico_alvo || '-'"
        />
      </dl>
    </div>

    <div class="flex g2">
      <dl class="f1 mb1">
        <dt class="t12 uc w700 mb05 tamarelo">
          {{ schema.fields['premissas'].spec.label }}
        </dt>
        <dd class="t13">
          <ul>
            <li v-if="!emFoco?.premissas?.length">
              {{ '-' }}
            </li>
            <li
              v-for="item in emFoco?.premissas"
              :key="item.id"
            >
              {{ item.premissa }}
            </li>
          </ul>
        </dd>
      </dl>
    </div>

    <div class="flex g2">
      <dl class="f1 mb1">
        <dt class="t12 uc w700 mb05 tamarelo">
          {{ schema.fields['restricoes'].spec.label }}
        </dt>
        <dd class="t13">
          <ul>
            <li v-if="!emFoco?.restricoes?.length">
              {{ '-' }}
            </li>
            <li
              v-for="item in emFoco?.restricoes"
              :key="item.id"
            >
              {{ item.restricao }}
            </li>
          </ul>
        </dd>
      </dl>
    </div>

    <div class="flex g2">
      <dl class="f1 mb1">
        <dt class="t12 uc w700 mb05 tamarelo">
          {{ schema.fields['escopo'].spec.label }}
        </dt>
        <dd class="t13">
          {{ emFoco?.escopo || '-' }}
        </dd>
      </dl>
    </div>

    <div class="flex g2">
      <dl class="f1 mb1">
        <dt class="t12 uc w700 mb05 tamarelo">
          {{ schema.fields['nao_escopo'].spec.label }}
        </dt>
        <dd
          class="t13"
          v-html="emFoco?.nao_escopo || '-'"
        />
      </dl>
    </div>

    <hr class="mb1 f1">

    <h2>
      {{ schema.fields['fonte_recursos'].spec.label }}
    </h2>

    <div class="flex g2 mb2">
      <table class="tablemain">
        <col class="col--minimum">
        <col>
        <col>
        <col>
        <col>
        <thead>
          <tr>
            <th
              class="cell--minimum"
              colspan="2"
            >
              {{ schema.fields.fonte_recursos.innerType.fields.fonte_recurso_cod_sof.spec.label }}
            </th>
            <th class="cell--number cell--minimum">
              {{ schema.fields.fonte_recursos.innerType.fields.fonte_recurso_ano.spec.label }}
            </th>
            <th class="cell--number cell--minimum">
              {{ schema.fields.fonte_recursos.innerType.fields.valor_nominal.spec.label }}
            </th>
            <th class="cell--number cell--minimum">
              {{ schema.fields.fonte_recursos.innerType.fields.valor_percentual.spec.label }}
            </th>
          </tr>
        </thead>

        <tr
          v-for="item in emFoco?.fonte_recursos"
          :key="item.id"
        >
          <td>
            {{ item.fonte_recurso_cod_sof }}
          </td>
          <td
            :title="FontesDeRecursosPorAnoPorCódigo?.[item.fonte_recurso_ano]?.[item.fonte_recurso_cod_sof]?.descricao"
          >
            <template
              v-if="FontesDeRecursosPorAnoPorCódigo?.[item.fonte_recurso_ano]?.[item.fonte_recurso_cod_sof]?.descricao"
            >
              {{
                truncate(
                  FontesDeRecursosPorAnoPorCódigo[item.fonte_recurso_ano][item.fonte_recurso_cod_sof].descricao,
                  36
                )
              }}
            </template>
          </td>
          <td class="cell--number">
            {{ item.fonte_recurso_ano }}
          </td>
          <td class="cell--number">
            {{ item.valor_nominal ? `R$ ${dinheiro(item.valor_nominal)}` : '-' }}
          </td>
          <td class="cell--number">
            {{ item.valor_percentual ? `${dinheiro(item.valor_percentual)}%` : '-' }}
          </td>
        </tr>
        <tr v-if="!emFoco?.fonte_recursos?.length">
          <td
            colspan="5"
            class="center"
          >
            -
          </td>
        </tr>
      </table>
    </div>

    <h2>
      Órgãos
    </h2>
    <div class="flex g2">
      <dl class="f1 mb1">
        <dt class="t12 uc w700 mb05 tamarelo">
          {{ schema.fields['orgao_gestor_id'].spec.label }}
        </dt>
        <dd class="t13">
          {{ emFoco?.orgao_gestor.sigla }} - {{ emFoco?.orgao_gestor.descricao }}
        </dd>
      </dl>
      <dl class="f1 mb1">
        <dt class="t12 uc w700 mb05 tamarelo">
          {{ schema.fields['responsaveis_no_orgao_gestor'].spec.label }}
        </dt>
        <dd class="t13">
          <template
            v-for="item in emFoco?.responsaveis_no_orgao_gestor"
            :key="item"
          >
            {{ item.nome_exibicao || item }},
          </template>
        </dd>
      </dl>
    </div>
    <div class="flex g2">
      <dl class="f1 mb1">
        <dt class="t12 uc w700 mb05 tamarelo">
          {{ schema.fields['orgao_responsavel_id'].spec.label }}
        </dt>
        <dd class="t13">
          {{ emFoco?.orgao_responsavel?.sigla }} - {{ emFoco?.orgao_responsavel?.descricao }}
        </dd>
      </dl>
      <dl class="f1 mb1">
        <dt class="t12 uc w700 mb05 tamarelo">
          Responsável
        </dt>
        <dd class="t13">
          {{ emFoco?.responsavel?.nome_exibicao || emFoco?.responsavel_id || '-' }}
        </dd>
      </dl>
    </div>

    <div class="flex g2">
      <dl class="f1 mb1">
        <dt class="t12 uc w700 mb05 tamarelo">
          {{ schema.fields['orgaos_participantes'].spec.label }}
        </dt>
        <dd class="t13">
          <template
            v-for="item in emFoco?.orgaos_participantes"
            :key="item.id"
          >
            {{ item.sigla }} - {{ item.descricao }},
          </template>
        </dd>
      </dl>
    </div>
  </div>

  <hr class="mb1 f1">

  <h2>
    Encerramento do projeto
  </h2>

  <table
    v-if="['Suspenso', 'Fechado'].indexOf(emFoco?.status) !== -1"
    class="tablemain"
  >
    <colgroup>
      <col>
      <col>
      <col>
      <col>
    </colgroup>

    <thead>
      <tr class="pl3 center mb05 tc300 w700 t12 uc">
        <th />
        <th class="tr">
          Planejado
        </th>
        <th class="tr">
          Realizado
        </th>
        <th class="tr">
          Desvio
        </th>
      </tr>
    </thead>

    <tbody>
      <tr>
        <th>
          Data de início
        </th>
        <td class="tr">
          {{ emFoco?.previsao_inicio ? dateToField(emFoco.previsao_inicio) : '-' }}
        </td>
        <td class="tr">
          {{ emFoco?.realizado_inicio ? dateToField(emFoco.realizado_inicio) : '-' }}
        </td>
        <td class="cell--number">
          {{ emFoco?.realizado_inicio && emFoco?.previsao_inicio
            ? `${subtractDates(emFoco.realizado_inicio, emFoco.previsao_inicio)} dias`
            : '-' }}
        </td>
      </tr>

      <tr>
        <th>
          Data de término
        </th>
        <td class="tr">
          {{ emFoco?.previsao_termino ? dateToField(emFoco.previsao_termino) : '-' }}
        </td>
        <td class="tr">
          {{ emFoco?.realizado_termino ? dateToField(emFoco.realizado_termino) : '-' }}
        </td>
        <td class="cell--number">
          {{ emFoco?.realizado_termino && emFoco?.previsao_termino
            ? `${subtractDates(emFoco.realizado_termino, emFoco.previsao_termino)} dias`
            : '-' }}
        </td>
      </tr>

      <tr>
        <th>
          Duração
        </th>
        <td class="cell--number">
          {{ emFoco?.previsao_duracao ? `${emFoco.previsao_duracao} dias` : '-' }}
        </td>
        <td class="cell--number">
          {{ emFoco?.realizado_duracao ? `${emFoco.realizado_duracao} dias` : '-' }}
        </td>
        <td class="cell--number">
          {{ emFoco?.realizado_duracao && emFoco?.previsao_duracao
            ? `${emFoco.realizado_duracao - emFoco.previsao_duracao} dias`
            : '-' }}
        </td>
      </tr>

      <tr>
        <th>
          Custo
        </th>
        <td class="cell--number">
          {{ emFoco?.previsao_custo ? `R$ ${dinheiro(emFoco.previsao_custo)}` : '-' }}
        </td>
        <td class="cell--number">
          {{ emFoco?.realizado_custo ? `R$ ${dinheiro(emFoco.realizado_custo)}` : '-' }}
        </td>
        <td class="cell--number">
          {{ emFoco?.realizado_custo && emFoco?.previsao_custo
            ? `R$ ${dinheiro(emFoco.realizado_custo - emFoco.previsao_custo)}`
            : '-' }}
        </td>
      </tr>
    </tbody>
  </table>

  <span
    v-if="chamadasPendentes?.emFoco"
    class="spinner"
  >Carregando</span>

  <div
    v-if="erro"
    class="error p1"
  >
    <div class="error-msg">
      {{ erro }}
    </div>
  </div>
</template>
